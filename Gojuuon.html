<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>äº”åéŸ³ç·´ç¿’ï¼ˆå«å­—å¡æ¨¡å¼ï¼‰</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #kana { font-size: 90px; margin: 20px 0; cursor: pointer; }
    #romaji { font-size: 40px; margin-top: -10px; display: none; }
    .option-btn {
        display: block; 
        margin: 8px auto; 
        padding: 10px 20px; 
        font-size: 22px;
        cursor: pointer; 
        width: 220px; 
    }
    #message { font-size: 22px; height: 40px; color: red; }
    .section { margin: 15px 0; }
    .note { color: #555; font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h1>äº”åéŸ³ç·´ç¿’ï¼ˆæ¸…éŸ³ / æ¿éŸ³ / åŠæ¿éŸ³ / æ‹—éŸ³ / å­—å¡æ¨¡å¼ï¼‰</h1>
<!--<button id="voiceStartBtn" style="font-size:22px;margin:10px;padding:10px 20px;">ğŸ”Š é»æˆ‘å•Ÿå‹•èªéŸ³ï¼ˆiPhone å¿…æŒ‰ï¼‰</button> -->

<!-- é¡å‹ -->
<div class="section">
    <label><input type="radio" name="type" value="hiragana" checked> å¹³å‡å</label>
    <label><input type="radio" name="type" value="katakana"> ç‰‡å‡å</label>
</div>

<!-- é¡Œåº« -->
<div class="section">
    <label><input type="checkbox" id="chk-basic" checked> æ¸…éŸ³</label>
    <label><input type="checkbox" id="chk-dakuon"> æ¿éŸ³</label>
    <label><input type="checkbox" id="chk-handakuon"> åŠæ¿éŸ³</label>
    <label><input type="checkbox" id="chk-youon"> æ‹—éŸ³</label>
</div>

<!-- æ¨¡å¼ -->
<div class="section">
    <label><input type="radio" name="mode" value="quiz" checked> æ¸¬é©—æ¨¡å¼</label>
    <label><input type="radio" name="mode" value="flashcard"> å­—å¡æ¨¡å¼</label>
</div>

<div class="section">
    <label><input type="radio" name="qaMode" value="kana2romaji" checked> å‡å â†’ ç¾…é¦¬éŸ³</label>
    <label><input type="radio" name="qaMode" value="romaji2kana"> ç¾…é¦¬éŸ³ â†’ å‡å</label>
</div>

<!-- æŒ‰éˆ• -->
<button id="startBtn" onclick="unlockVoice(); newQuestion()" style="font-size:22px;margin:10px;padding:10px 20px;">é–‹å§‹ / ä¸‹ä¸€é¡Œ</button>

<div id="kana">ã‚</div>
<div id="romaji">a</div>

<div id="options"></div>
<div id="message"></div>

<script>
// ------------------------------------------------------
// iOS / Android èªéŸ³è§£é–ï¼ˆæ–°ç‰ˆå¯ç”¨ï¼‰
// ------------------------------------------------------

let voiceUnlocked = false;

function forceVoiceStart(){
    let u = new SpeechSynthesisUtterance("ã‚");
    u.lang = "ja-JP";

    u.onend = () => {
        voiceUnlocked = true;
        alert("èªéŸ³å·²å•Ÿå‹•ï¼Œä¹‹å¾Œæœƒæ­£å¸¸ç™¼éŸ³ï¼");
    };

    speechSynthesis.speak(u);
}

document.getElementById("voiceStartBtn").addEventListener("click", function(){
    let u = new SpeechSynthesisUtterance("ã‚");
    u.lang = "ja-JP";
    u.onend = function(){
        voiceUnlocked = true;
        alert("èªéŸ³å·²å•Ÿå‹•ï¼Œå¯ä»¥æ­£å¸¸ç™¼éŸ³äº†ï¼");
    };
    speechSynthesis.speak(u);
});

function unlockVoice(){
    if (voiceUnlocked) return;

    // iOS å¿…é ˆç™¼çœŸæ­£çš„è²éŸ³æ‰èƒ½è§£é–ï¼Œç©ºç™½ä¸è¡Œ
    let u = new SpeechSynthesisUtterance("ã‚");
    u.lang = "ja-JP";

    // iOS å¼•æ“åˆå§‹åŒ–è‡³å°‘éœ€è¦ 300â€“800ms
    u.onend = () => {
        setTimeout(() => {
            voiceUnlocked = true;
            console.log("èªéŸ³å·²è§£é–ï¼");
        }, 600);
    };

    try {
        speechSynthesis.speak(u);
    } catch(e) {
        console.warn("èªéŸ³è§£é–å¤±æ•—ï¼š", e);
    }
}

// ------------------------------------------------------
// å‡åè³‡æ–™
// ------------------------------------------------------
const data = {
    basic: [
        ["ã‚","a"],["ã„","i"],["ã†","u"],["ãˆ","e"],["ãŠ","o"],
        ["ã‹","ka"],["ã","ki"],["ã","ku"],["ã‘","ke"],["ã“","ko"],
        ["ã•","sa"],["ã—","shi"],["ã™","su"],["ã›","se"],["ã","so"],
        ["ãŸ","ta"],["ã¡","chi"],["ã¤","tsu"],["ã¦","te"],["ã¨","to"],
        ["ãª","na"],["ã«","ni"],["ã¬","nu"],["ã­","ne"],["ã®","no"],
        ["ã¯","ha"],["ã²","hi"],["ãµ","fu"],["ã¸","he"],["ã»","ho"],
        ["ã¾","ma"],["ã¿","mi"],["ã‚€","mu"],["ã‚","me"],["ã‚‚","mo"],
        ["ã‚„","ya"],["ã‚†","yu"],["ã‚ˆ","yo"],
        ["ã‚‰","ra"],["ã‚Š","ri"],["ã‚‹","ru"],["ã‚Œ","re"],["ã‚","ro"],
        ["ã‚","wa"],["ã‚’","wo"],["ã‚“","n"]
    ],
    dakuon: [
        ["ãŒ","ga"],["ã","gi"],["ã","gu"],["ã’","ge"],["ã”","go"],
        ["ã–","za"],["ã˜","ji"],["ãš","zu"],["ãœ","ze"],["ã","zo"],
        ["ã ","da"],["ã¢","ji"],["ã¥","zu"],["ã§","de"],["ã©","do"],
        ["ã°","ba"],["ã³","bi"],["ã¶","bu"],["ã¹","be"],["ã¼","bo"]
    ],
    handakuon: [
        ["ã±","pa"],["ã´","pi"],["ã·","pu"],["ãº","pe"],["ã½","po"]
    ],
    youon: [
        ["ãã‚ƒ","kya"],["ãã‚…","kyu"],["ãã‚‡","kyo"],
        ["ã—ã‚ƒ","sha"],["ã—ã‚…","shu"],["ã—ã‚‡","sho"],
        ["ã¡ã‚ƒ","cha"],["ã¡ã‚…","chu"],["ã¡ã‚‡","cho"],
        ["ã«ã‚ƒ","nya"],["ã«ã‚…","nyu"],["ã«ã‚‡","nyo"],
        ["ã²ã‚ƒ","hya"],["ã²ã‚…","hyu"],["ã²ã‚‡","hyo"],
        ["ã¿ã‚ƒ","mya"],["ã¿ã‚…","myu"],["ã¿ã‚‡","myo"],
        ["ã‚Šã‚ƒ","rya"],["ã‚Šã‚…","ryu"],["ã‚Šã‚‡","ryo"],
        ["ãã‚ƒ","gya"],["ãã‚…","gyu"],["ãã‚‡","gyo"],
        ["ã˜ã‚ƒ","ja"],["ã˜ã‚…","ju"],["ã˜ã‚‡","jo"],
        ["ã³ã‚ƒ","bya"],["ã³ã‚…","byu"],["ã³ã‚‡","byo"],
        ["ã´ã‚ƒ","pya"],["ã´ã‚…","pyu"],["ã´ã‚‡","pyo"]
    ]
};

// å‡å â†’ ç‰‡å‡å
function hiraToKata(str){
    return str.replace(/[\u3041-\u3096]/g, ch =>
        String.fromCharCode(ch.charCodeAt(0) + 0x60)
    );
}

function findKanaByRomaji(romaji, groups, useHira){
    for(let g of groups){
        for(let [kana, roma] of g){
            if(romaji === roma)
                return useHira ? kana : hiraToKata(kana);
        }
    }
    return "";
}

// ------------------------------------------------------
// æ’­æ”¾èªéŸ³ï¼ˆiOS + Androidï¼‰
// ------------------------------------------------------
function speakKana(kana, fast=false){
    if (!voiceUnlocked) {
        console.log("èªéŸ³å°šæœªè§£é–");
        return;
    }

    let u = new SpeechSynthesisUtterance(kana);
    u.lang = "ja-JP";
    u.rate = fast ? 1.1 : 0.9;

    try {
        speechSynthesis.speak(u);
    } catch(e){
        console.warn("èªéŸ³æ’­æ”¾å¤±æ•—ï¼š", e);
    }
}

let selectedGroups = [];
let answerRomaji = "";
let answerKana = "";
let useHira = true;
let flashStep = 0;

// ------------------------------------------------------
// å­—å¡ç¿»é¢
// ------------------------------------------------------
function flashClick(){
    const romajiDiv = document.getElementById("romaji");

    if(flashStep === 0){
        romajiDiv.style.display = "block";
        flashStep = 1;
    } else if(flashStep === 1){
        speakKana(answerKana, true);
        flashStep = 2;
    } else {
        newQuestion();
    }
}

// ------------------------------------------------------
// ç”¢ç”Ÿé¡Œç›®
// ------------------------------------------------------
function newQuestion(){
    useHira = document.querySelector("input[name=type]:checked").value === "hiragana";
    const mode = document.querySelector("input[name=mode]:checked").value;
    const qaMode = document.querySelector("input[name=qaMode]:checked").value;

    let pool = [];
    if(document.getElementById("chk-basic").checked) pool.push(data.basic);
    if(document.getElementById("chk-dakuon").checked) pool.push(data.dakuon);
    if(document.getElementById("chk-handakuon").checked) pool.push(data.handakuon);
    if(document.getElementById("chk-youon").checked) pool.push(data.youon);

    if(pool.length === 0){
        alert("è«‹è‡³å°‘é¸ 1 é¡å‡å");
        return;
    }

    selectedGroups = pool;

    let group = pool[Math.floor(Math.random()*pool.length)];
    let [kana, romaji] = group[Math.floor(Math.random()*group.length)];

    answerRomaji = romaji;
    answerKana = useHira ? kana : hiraToKata(kana);

    const kanaDiv = document.getElementById("kana");
    const romajiDiv = document.getElementById("romaji");
    const optDiv = document.getElementById("options");
    const msg = document.getElementById("message");

    romajiDiv.textContent = answerRomaji;
    kanaDiv.textContent = answerKana;
    msg.textContent = "";

    // å­—å¡æ¨¡å¼
    if(mode === "flashcard"){
        optDiv.style.display = "none";
        romajiDiv.style.display = "none";
        flashStep = 0;
        kanaDiv.onclick = flashClick;
        return;
    }

    // æ¸¬é©—æ¨¡å¼
    kanaDiv.onclick = null;
    optDiv.style.display = "block";
    romajiDiv.style.display = "none";

    let choiceSet = new Set();

    if(qaMode === "kana2romaji"){
        kanaDiv.textContent = answerKana;
        choiceSet.add(answerRomaji);

        while(choiceSet.size < 6){
            let g = pool[Math.floor(Math.random()*pool.length)];
            let r = g[Math.floor(Math.random()*g.length)][1];
            choiceSet.add(r);
        }

    } else {
        kanaDiv.textContent = answerRomaji;
        choiceSet.add(answerKana);

        while(choiceSet.size < 6){
            let g = pool[Math.floor(Math.random()*pool.length)];
            let [kana] = g[Math.floor(Math.random()*g.length)];
            let kanaOut = useHira ? kana : hiraToKata(kana);
            choiceSet.add(kanaOut);
        }
    }

    let choiceList = Array.from(choiceSet).sort(()=>Math.random()-0.5);
    optDiv.innerHTML = "";

    choiceList.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt;

        btn.onclick = () => {
            if(qaMode === "kana2romaji"){
                let kanaSpeak = findKanaByRomaji(opt, selectedGroups, useHira);
                speakKana(kanaSpeak);
            } else {
                speakKana(opt);
            }
            checkAnswer(opt, qaMode);
        };

        optDiv.appendChild(btn);
    });
}

function checkAnswer(opt, qaMode){
    if(qaMode === "kana2romaji"){
        if(opt === answerRomaji) newQuestion();
        else message.textContent = "å†è©¦ä¸€æ¬¡ï¼";
    } else {
        if(opt === answerKana) newQuestion();
        else message.textContent = "å†è©¦ä¸€æ¬¡ï¼";
    }
}
</script>

</body>
</html>
