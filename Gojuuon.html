<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>五十音練習（含字卡模式）</title>
<style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #kana { font-size: 90px; margin: 20px 0; cursor: pointer; }
    #romaji { font-size: 40px; margin-top: -10px; display: none; }
    .option-btn {
        display: block; 
        margin: 8px auto; 
        padding: 10px 20px; 
        font-size: 22px;
        cursor: pointer; 
        width: 220px; 
    }
    #message { font-size: 22px; height: 40px; color: red; }
    .section { margin: 15px 0; }
    .note { color: #555; font-size: 16px; margin-top: 10px; }
</style>
</head>
<body>

<h1>五十音練習（清音 / 濁音 / 半濁音 / 拗音 / 字卡模式）</h1>

<!-- 類型 -->
<div class="section">
    <label class="big-label"><input class="big-radio" type="radio" name="type" value="hiragana" checked> 平假名</label>
    <label class="big-label"><input class="big-radio" type="radio" name="type" value="katakana"> 片假名</label>
</div>

<!-- 題庫 -->
<div class="section">
    <label class="big-label"><input class="big-radio" type="checkbox" id="chk-basic" checked> 清音</label>
    <label class="big-label"><input class="big-radio" type="checkbox" id="chk-dakuon"> 濁音</label>
    <label class="big-label"><input class="big-radio" type="checkbox" id="chk-handakuon"> 半濁音</label>
    <label class="big-label"><input class="big-radio" type="checkbox" id="chk-youon"> 拗音</label>
</div>

<!-- 模式 -->
<div class="section">
    <label class="big-label"><input class="big-radio" type="radio" name="mode" value="quiz" checked> 測驗模式</label>
    <label class="big-label"><input class="big-radio" type="radio" name="mode" value="flashcard"> 字卡模式</label>
</div>

<div class="section">
    <label class="big-label"><input class="big-radio" type="radio" name="qaMode" value="kana2romaji" checked> 假名 → 羅馬音</label>
    <label class="big-label"><input class="big-radio" type="radio" name="qaMode" value="romaji2kana"> 羅馬音 → 假名</label>
</div>

<!-- 按鈕 -->
<button id="startBtn" onclick="unlockVoice(); newQuestion();" style="font-size:22px;margin:10px;padding:10px 20px;">開始 / 下一題</button>

<div id="kana">あ</div>
<div id="romaji">a</div>

<div id="options"></div>
<div id="message"></div>

<script>
// ------------------------------------------------------
// iOS / Android 語音解鎖（新版可用）
// ------------------------------------------------------

let voiceUnlocked = false;


// ------------------------------------------------------
// 假名資料
// ------------------------------------------------------
const data = {
    basic: [
        ["あ","a"],["い","i"],["う","u"],["え","e"],["お","o"],
        ["か","ka"],["き","ki"],["く","ku"],["け","ke"],["こ","ko"],
        ["さ","sa"],["し","shi"],["す","su"],["せ","se"],["そ","so"],
        ["た","ta"],["ち","chi"],["つ","tsu"],["て","te"],["と","to"],
        ["な","na"],["に","ni"],["ぬ","nu"],["ね","ne"],["の","no"],
        ["は","ha"],["ひ","hi"],["ふ","fu"],["へ","he"],["ほ","ho"],
        ["ま","ma"],["み","mi"],["む","mu"],["め","me"],["も","mo"],
        ["や","ya"],["ゆ","yu"],["よ","yo"],
        ["ら","ra"],["り","ri"],["る","ru"],["れ","re"],["ろ","ro"],
        ["わ","wa"],["を","wo"],["ん","n"]
    ],
    dakuon: [
        ["が","ga"],["ぎ","gi"],["ぐ","gu"],["げ","ge"],["ご","go"],
        ["ざ","za"],["じ","ji"],["ず","zu"],["ぜ","ze"],["ぞ","zo"],
        ["だ","da"],["ぢ","ji"],["づ","zu"],["で","de"],["ど","do"],
        ["ば","ba"],["び","bi"],["ぶ","bu"],["べ","be"],["ぼ","bo"]
    ],
    handakuon: [
        ["ぱ","pa"],["ぴ","pi"],["ぷ","pu"],["ぺ","pe"],["ぽ","po"]
    ],
    youon: [
        ["きゃ","kya"],["きゅ","kyu"],["きょ","kyo"],
        ["しゃ","sha"],["しゅ","shu"],["しょ","sho"],
        ["ちゃ","cha"],["ちゅ","chu"],["ちょ","cho"],
        ["にゃ","nya"],["にゅ","nyu"],["にょ","nyo"],
        ["ひゃ","hya"],["ひゅ","hyu"],["ひょ","hyo"],
        ["みゃ","mya"],["みゅ","myu"],["みょ","myo"],
        ["りゃ","rya"],["りゅ","ryu"],["りょ","ryo"],
        ["ぎゃ","gya"],["ぎゅ","gyu"],["ぎょ","gyo"],
        ["じゃ","ja"],["じゅ","ju"],["じょ","jo"],
        ["びゃ","bya"],["びゅ","byu"],["びょ","byo"],
        ["ぴゃ","pya"],["ぴゅ","pyu"],["ぴょ","pyo"]
    ]
};

function unlockVoice(){
    let u = new SpeechSynthesisUtterance("あ");
    u.lang = "ja-JP";
    speechSynthesis.speak(u);
    voiceUnlocked = true;
}



// 假名 → 片假名
function hiraToKata(str){
    return str.replace(/[\u3041-\u3096]/g, ch =>
        String.fromCharCode(ch.charCodeAt(0) + 0x60)
    );
}

function findKanaByRomaji(romaji, groups, useHira){
    for(let g of groups){
        for(let [kana, roma] of g){
            if(romaji === roma)
                return useHira ? kana : hiraToKata(kana);
        }
    }
    return "";
}

// ------------------------------------------------------
// 播放語音（iOS + Android）
// ------------------------------------------------------
/*
function speakKana(kana, fast=false){
    let u = new SpeechSynthesisUtterance(kana);
    u.lang = "ja-JP";
    u.rate = fast ? 1.1 : 0.9;

    try {
        speechSynthesis.speak(u);
    } catch(e){
        console.warn("語音播放失敗：", e);
    }
}
*/
function speakKana(kana, fast=false){
    if(!voiceUnlocked) return;

    speechSynthesis.cancel();

    let u = new SpeechSynthesisUtterance(kana);
    u.lang = "ja-JP";
    u.rate = fast ? 1.1 : 0.9;

    speechSynthesis.speak(u);
}


let selectedGroups = [];
let answerRomaji = "";
let answerKana = "";
let useHira = true;
let flashStep = 0;

// ------------------------------------------------------
// 字卡翻面
// ------------------------------------------------------
function flashClick(){
    const romajiDiv = document.getElementById("romaji");

    if(flashStep === 0){
        romajiDiv.style.display = "block"
		speakKana(answerKana, true);
        flashStep = 1;
		
    } /*else if(flashStep === 1){
        speakKana(answerKana, true);
        flashStep = 2;
    }*/ else {
        newQuestion();
    }
}

// ------------------------------------------------------
// 產生題目
// ------------------------------------------------------
function newQuestion(){
    useHira = document.querySelector("input[name=type]:checked").value === "hiragana";
    const mode = document.querySelector("input[name=mode]:checked").value;
    const qaMode = document.querySelector("input[name=qaMode]:checked").value;

    let pool = [];
    if(document.getElementById("chk-basic").checked) pool.push(data.basic);
    if(document.getElementById("chk-dakuon").checked) pool.push(data.dakuon);
    if(document.getElementById("chk-handakuon").checked) pool.push(data.handakuon);
    if(document.getElementById("chk-youon").checked) pool.push(data.youon);

    if(pool.length === 0){
        alert("請至少選 1 類假名");
        return;
    }

    selectedGroups = pool;

    let group = pool[Math.floor(Math.random()*pool.length)];
    let [kana, romaji] = group[Math.floor(Math.random()*group.length)];

    answerRomaji = romaji;
    answerKana = useHira ? kana : hiraToKata(kana);

    const kanaDiv = document.getElementById("kana");
    const romajiDiv = document.getElementById("romaji");
    const optDiv = document.getElementById("options");
    const msg = document.getElementById("message");

    romajiDiv.textContent = answerRomaji;
    kanaDiv.textContent = answerKana;
    msg.textContent = "";

    // 字卡模式
    if(mode === "flashcard"){
        optDiv.style.display = "none";
        romajiDiv.style.display = "none";
        flashStep = 0;
        kanaDiv.onclick = flashClick;
        return;
    }

    // 測驗模式
    kanaDiv.onclick = null;
    optDiv.style.display = "block";
    romajiDiv.style.display = "none";

    let choiceSet = new Set();

    if(qaMode === "kana2romaji"){
        kanaDiv.textContent = answerKana;
        choiceSet.add(answerRomaji);

        while(choiceSet.size < 6){
            let g = pool[Math.floor(Math.random()*pool.length)];
            let r = g[Math.floor(Math.random()*g.length)][1];
            choiceSet.add(r);
        }

    } else {
        kanaDiv.textContent = answerRomaji;
        choiceSet.add(answerKana);

        while(choiceSet.size < 6){
            let g = pool[Math.floor(Math.random()*pool.length)];
            let [kana] = g[Math.floor(Math.random()*g.length)];
            let kanaOut = useHira ? kana : hiraToKata(kana);
            choiceSet.add(kanaOut);
        }
    }

    let choiceList = Array.from(choiceSet).sort(()=>Math.random()-0.5);
    optDiv.innerHTML = "";

    choiceList.forEach(opt => {
        let btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = opt;
		
		btn.style.cssText = `
			font-size: 24px;
			margin: 10px auto;
			padding: 10px 20px;
		`;

        btn.onclick = () => {
            if(qaMode === "kana2romaji"){
                let kanaSpeak = findKanaByRomaji(opt, selectedGroups, useHira);
                speakKana(kanaSpeak);
            } else {
                speakKana(opt);
            }
            checkAnswer(opt, qaMode);
        };

        optDiv.appendChild(btn);
    });
}

function checkAnswer(opt, qaMode){
    if(qaMode === "kana2romaji"){
        if(opt === answerRomaji) newQuestion();
        else message.textContent = "再試一次！";
    } else {
        if(opt === answerKana) newQuestion();
        else message.textContent = "再試一次！";
    }
}
</script>

<style>
  .big-label {
    font-size: 22px;
  }
  .big-radio {
    transform: scale(1.5);
    margin-right: 5px;
  }
</style>

</body>
</html>
